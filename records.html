<!DOCTYPE html>
<html>
<head>
    <title>View Records</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <script>
        // Check for saved theme preference, otherwise use system preference
        const getPreferredTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) return savedTheme;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        // Apply theme immediately to prevent flash
        document.documentElement.setAttribute('data-theme', getPreferredTheme());
    </script>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">ðŸŒ“</button>
    <h1>Work Records</h1>
    <nav>
        <a href="./home.html">Home</a>
        <a href="./track.html">Track Time</a>
        <a href="./records.html">View Records</a>
        <a href="./stats.html">Statistics</a>
    </nav>
    <div class="button-container">
        <button id="clearDataButton">Clear Test Data</button>
        <button id="exportBackupButton">Export Backup</button>
        <button id="importBackupButton">Import Backup</button>
        <input type="file" id="importFileInput" style="display: none;">
        <button id="saveToFileButton">Save to File</button>
        <button id="loadFromFileButton">Load from File</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody id="recordsTableBody">
            <!-- Records will be dynamically inserted here -->
        </tbody>
    </table>

    <script>
        // Add this at the start of your existing script
        const themeToggle = document.getElementById('themeToggle');
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        themeToggle.addEventListener('click', toggleTheme);

        const records = JSON.parse(localStorage.getItem('workRecords')) || [];
        const tableBody = document.getElementById('recordsTableBody');
        const clearDataButton = document.getElementById('clearDataButton');
        const exportBackupButton = document.getElementById('exportBackupButton');
        const importBackupButton = document.getElementById('importBackupButton');
        const importFileInput = document.getElementById('importFileInput');

        // Function to format duration into hours and minutes
        function formatDuration(duration) {
            const totalMinutes = Math.round(duration * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours} hour${hours !== 1 ? 's' : ''} ${minutes} minute${minutes !== 1 ? 's' : ''}`;
        }

        // Populate the table with records
        if (records.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5">No records found</td></tr>';
        } else {
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.startTime}</td>
                    <td>${record.endTime}</td>
                    <td>${formatDuration(record.duration)}</td>
                    <td>${record.notes}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Clear all data
        clearDataButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all data?')) {
                localStorage.removeItem('workRecords');
                location.reload();
            }
        });

        // Export data as JSON file
        exportBackupButton.addEventListener('click', () => {
            const dataStr = JSON.stringify(records, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workRecordsBackup.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Import data from JSON file
        importBackupButton.addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            localStorage.setItem('workRecords', JSON.stringify(importedData));
                            alert('Backup imported successfully!');
                            location.reload();
                        } else {
                            alert('Invalid backup file format.');
                        }
                    } catch (error) {
                        alert('Error reading backup file.');
                    }
                };
                reader.readAsText(file);
            }
        });

        const GITHUB_API_URL = 'https://api.github.com';
        const REPO_OWNER = 'natte-code';
        const REPO_NAME = 'Work-website-time-tracker';
        const FILE_PATH = 'data/workRecords.json';
        // Remove hardcoded token
        const CONFIG_PATH = 'config.json';

        const saveToFileButton = document.getElementById('saveToFileButton');
        const loadFromFileButton = document.getElementById('loadFromFileButton');

        // Load config first
        async function getGitHubToken() {
            try {
                const response = await fetch(CONFIG_PATH);
                if (!response.ok) {
                    throw new Error('Config file not found');
                }
                const config = await response.json();
                if (!config.githubToken || config.githubToken === 'YOUR_GITHUB_TOKEN') {
                    alert('Please configure your GitHub token in config.json:\n\n' +
                          '1. Go to GitHub.com -> Settings -> Developer settings\n' +
                          '2. Select Personal access tokens -> Tokens (classic)\n' +
                          '3. Generate new token with "repo" scope\n' +
                          '4. Copy token and paste it in config.json');
                    return null;
                }
                return config.githubToken;
            } catch (error) {
                alert('Config file not found. Please create config.json with your GitHub token.');
                return null;
            }
        }

        // Save data to GitHub
        saveToFileButton.addEventListener('click', async () => {
            const token = await getGitHubToken();
            if (!token) {
                alert('GitHub token not configured');
                return;
            }
            try {
                const records = JSON.parse(localStorage.getItem('workRecords')) || [];
                const fileContent = btoa(JSON.stringify(records, null, 2)); // Base64 encode the JSON data

                // Get the current file SHA
                const response = await fetch(`${GITHUB_API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    headers: { Authorization: `token ${token}` }
                });

                const fileData = await response.json();
                const sha = fileData.sha;

                // Update the file on GitHub
                const updateResponse = await fetch(`${GITHUB_API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update work records',
                        content: fileContent,
                        sha: sha
                    })
                });

                if (updateResponse.ok) {
                    alert('Data saved successfully on GitHub!');
                } else {
                    alert('Failed to save data on GitHub.');
                }
            } catch (error) {
                alert('Error saving data on GitHub.');
            }
        });

        // Load data from GitHub
        loadFromFileButton.addEventListener('click', async () => {
            const token = await getGitHubToken();
            if (!token) {
                alert('GitHub token not configured');
                return;
            }
            try {
                const response = await fetch(`${GITHUB_API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    headers: { Authorization: `token ${token}` }
                });

                if (response.ok) {
                    const fileData = await response.json();
                    const fileContent = atob(fileData.content); // Decode Base64 content
                    const records = JSON.parse(fileContent);

                    localStorage.setItem('workRecords', JSON.stringify(records));
                    alert('Data loaded successfully from GitHub!');
                    location.reload();
                } else {
                    alert('Failed to load data from GitHub.');
                }
            } catch (error) {
                alert('Error loading data from GitHub.');
            }
        });
    </script>
</body>
</html>
